<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OBY Energy - Gestor de Templates</title>
    <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/docx@7.8.2/build/index.js"></script>
    <script src="https://unpkg.com/file-saver@2.0.5/dist/FileSaver.min.js"></script>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        const SUPABASE_URL = 'https://uuaqmwnfjopgjmjjchmw.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InV1YXFtd25mam9wZ2ptampjaG13Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1OTEyNzUsImV4cCI6MjA3NjE2NzI3NX0.9ITSBR9SNoZKgvF1AuW4OsL4b8Du5NAXttQpi7B3MO8';

        // Template base do Termo de Ades√£o
        const TEMPLATE_BASE = `PROPOSTA DE ADES√ÉO AO CONTRATO DE CONS√ìRCIO

O(A) PROPONENTE CONSORCIADO(A) encaminha sua Proposta de Ades√£o ao CONS√ìRCIO, conforme condi√ß√µes abaixo:

DADOS DO CONS√ìRCIO
Raz√£o Social: [Razao_Social_Consorcio]
CNPJ: [CNPJ_Consorcio]
Endere√ßo: [Endereco_Consorcio]
Consorciada L√≠der: [Consorciada_Lider]

DADOS DO(A) PROPONENTE CONSORCIADO(A):
Raz√£o Social: [Nome_do_Cliente]
CNPJ: [CPF_CNPJ]
Endere√ßo: [Endereco_Completo]
Representante Legal: [Representante_Legal]
E-mail de contato: [Email]
N¬∫ Unidade Consumidora: [Numero_da_Instalacao]
N¬∫ Cliente Concession√°ria: [Numero_Cliente_Concessionaria]
Tipo de Conex√£o: [Tipo_de_Conexao]
Consumo m√≠nimo (kWh): [Consumo]
Desconto sobre a Energia Injetada pelo Cons√≥rcio (%): [Desconto_Percentual]

ADES√ÉO AO CONS√ìRCIO
O(A) PROPONENTE CONSORCIADO(A) prop√µe neste ato ingressar no CONS√ìRCIO, e compromete-se a cumprir o Contrato de Cons√≥rcio celebrado entre a L√çDER e as demais Partes Consorciadas.

[Cidade], [Data]

_________________________________
CONTRATANTE
[Nome_do_Cliente]
CPF/CNPJ: [CPF_CNPJ]

_________________________________
OBY ENERGY - CONTRATADA`;

        // Campos vari√°veis dispon√≠veis
        const CAMPOS_PADRAO = [
            { id: 1, nome: '[Nome_do_Cliente]', descricao: 'Nome completo do cliente', categoria: 'Cliente' },
            { id: 2, nome: '[CPF_CNPJ]', descricao: 'CPF ou CNPJ do cliente', categoria: 'Cliente' },
            { id: 3, nome: '[Email]', descricao: 'E-mail do cliente', categoria: 'Cliente' },
            { id: 4, nome: '[Telefone]', descricao: 'Telefone do cliente', categoria: 'Cliente' },
            { id: 5, nome: '[Endereco_Completo]', descricao: 'Endere√ßo completo', categoria: 'Endere√ßo' },
            { id: 6, nome: '[Cidade]', descricao: 'Cidade', categoria: 'Endere√ßo' },
            { id: 7, nome: '[Estado]', descricao: 'Estado (UF)', categoria: 'Endere√ßo' },
            { id: 8, nome: '[CEP]', descricao: 'CEP', categoria: 'Endere√ßo' },
            { id: 9, nome: '[Numero_da_Instalacao]', descricao: 'N√∫mero da instala√ß√£o', categoria: 'Instala√ß√£o' },
            { id: 10, nome: '[Distribuidora]', descricao: 'Distribuidora de energia', categoria: 'Instala√ß√£o' },
            { id: 11, nome: '[Consumo]', descricao: 'Consumo em kWh', categoria: 'Instala√ß√£o' },
            { id: 12, nome: '[Tipo_de_Conexao]', descricao: 'Tipo de conex√£o (Mono/Bi/Tri)', categoria: 'Instala√ß√£o' },
            { id: 13, nome: '[Numero_do_Contrato]', descricao: 'N√∫mero do contrato OBY', categoria: 'Contrato' },
            { id: 14, nome: '[Data]', descricao: 'Data atual formatada', categoria: 'Contrato' },
            { id: 15, nome: '[Desconto_Percentual]', descricao: 'Percentual de desconto (%)', categoria: 'Financeiro' },
            { id: 16, nome: '[Custo_Atual]', descricao: 'Custo atual (R$)', categoria: 'Financeiro' },
            { id: 17, nome: '[Custo_OBY]', descricao: 'Custo OBY (R$)', categoria: 'Financeiro' },
            { id: 18, nome: '[Economia_Mensal]', descricao: 'Economia mensal (R$)', categoria: 'Financeiro' },
            { id: 19, nome: '[Razao_Social_Consorcio]', descricao: 'Raz√£o social do cons√≥rcio', categoria: 'Cons√≥rcio' },
            { id: 20, nome: '[CNPJ_Consorcio]', descricao: 'CNPJ do cons√≥rcio', categoria: 'Cons√≥rcio' },
        ];

        function GestorTemplates() {
            const [template, setTemplate] = useState(TEMPLATE_BASE);
            const [campos, setCampos] = useState(CAMPOS_PADRAO);
            const [novoCampo, setNovoCampo] = useState({ nome: '', descricao: '', categoria: 'Personalizado' });
            const [salvando, setSalvando] = useState(false);
            const [proposta, setProposta] = useState(null);

            // Carregar template do Supabase ao iniciar
            useEffect(() => {
                carregarTemplateDoSupabase();
            }, []);

            const carregarTemplateDoSupabase = async () => {
                try {
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?select=*&limit=1`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    
                    if (response.ok) {
                        const templates = await response.json();
                        if (templates && templates.length > 0) {
                            setTemplate(templates[0].template_completo);
                            console.log('‚úÖ Template carregado do Supabase');
                        } else {
                            // Tentar carregar do localStorage
                            const localTemplate = localStorage.getItem('oby_template_contrato');
                            if (localTemplate) {
                                setTemplate(localTemplate);
                                console.log('‚úÖ Template carregado do localStorage');
                            }
                        }
                    }
                } catch (error) {
                    console.error('Erro ao carregar do Supabase:', error);
                    // Tentar carregar do localStorage como fallback
                    const localTemplate = localStorage.getItem('oby_template_contrato');
                    if (localTemplate) {
                        setTemplate(localTemplate);
                        console.log('‚úÖ Template carregado do localStorage (fallback)');
                    }
                }
                
                // Carregar campos customizados do localStorage
                const camposSalvos = localStorage.getItem('oby_campos_customizados');
                if (camposSalvos) {
                    try {
                        setCampos(JSON.parse(camposSalvos));
                    } catch (e) {
                        console.error('Erro ao carregar campos:', e);
                    }
                }
            };

            const adicionarCampo = () => {
                if (!novoCampo.nome || !novoCampo.descricao) {
                    alert('Preencha nome e descri√ß√£o do campo!');
                    return;
                }
                
                const nomeCampo = novoCampo.nome.startsWith('[') ? novoCampo.nome : `[${novoCampo.nome}]`;
                const novoCampoObj = {
                    id: campos.length + 1,
                    nome: nomeCampo,
                    descricao: novoCampo.descricao,
                    categoria: novoCampo.categoria
                };
                
                setCampos([...campos, novoCampoObj]);
                setNovoCampo({ nome: '', descricao: '', categoria: 'Personalizado' });
                alert('‚úÖ Campo adicionado!');
            };

            const removerCampo = (id) => {
                if (confirm('Remover este campo?')) {
                    setCampos(campos.filter(c => c.id !== id));
                }
            };

            const inserirCampo = (nomeCampo) => {
                const textarea = document.getElementById('editor-template');
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                const antes = text.substring(0, start);
                const depois = text.substring(end);
                
                setTemplate(antes + nomeCampo + depois);
                
                // Reposicionar cursor
                setTimeout(() => {
                    textarea.focus();
                    textarea.setSelectionRange(start + nomeCampo.length, start + nomeCampo.length);
                }, 10);
            };

            const salvarTemplate = async () => {
                setSalvando(true);
                try {
                    // Salvar no localStorage (backup local)
                    localStorage.setItem('oby_template_contrato', template);
                    localStorage.setItem('oby_campos_customizados', JSON.stringify(campos));
                    
                    // Salvar no Supabase - buscar o √∫nico registro
                    const checkResponse = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?select=id&limit=1`, {
                        headers: {
                            'Authorization': `Bearer ${SUPABASE_KEY}`,
                            'apikey': SUPABASE_KEY
                        }
                    });
                    
                    const existentes = await checkResponse.json();
                    
                    let response;
                    if (existentes && existentes.length > 0) {
                        // Atualizar o registro existente
                        response = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates?id=eq.${existentes[0].id}`, {
                            method: 'PATCH',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify({
                                template_completo: template
                            })
                        });
                    } else {
                        // Criar novo registro (primeira vez)
                        response = await fetch(`${SUPABASE_URL}/rest/v1/contrato_templates`, {
                            method: 'POST',
                            headers: {
                                'Authorization': `Bearer ${SUPABASE_KEY}`,
                                'apikey': SUPABASE_KEY,
                                'Content-Type': 'application/json',
                                'Prefer': 'return=minimal'
                            },
                            body: JSON.stringify({
                                template_completo: template
                            })
                        });
                    }
                    
                    if (response.ok) {
                        alert('‚úÖ Template salvo com sucesso no Supabase e localmente!');
                    } else {
                        const errorText = await response.text();
                        throw new Error(errorText || 'Erro ao salvar no Supabase');
                    }
                } catch (error) {
                    console.error('Erro ao salvar:', error);
                    alert('‚ùå Erro ao salvar no Supabase: ' + error.message + '\n\nMas foi salvo localmente no navegador.');
                } finally {
                    setSalvando(false);
                }
            };

            const gerarPrevia = () => {
                const dadosExemplo = {
                    '[Nome_do_Cliente]': 'ICARAIMA II LTDA',
                    '[CPF_CNPJ]': '46176395/0001-89',
                    '[Email]': 'contato@obyenergy.com',
                    '[Telefone]': '41 3779-3503',
                    '[Endereco_Completo]': 'Rua Exemplo, 123, Centro, Curitiba - PR',
                    '[Cidade]': 'Curitiba',
                    '[Estado]': 'PR',
                    '[CEP]': '80000-000',
                    '[Numero_da_Instalacao]': '21859167',
                    '[Distribuidora]': 'COPEL',
                    '[Consumo]': '5000',
                    '[Tipo_de_Conexao]': 'Trif√°sica',
                    '[Numero_do_Contrato]': 'OBY-2025-12345',
                    '[Data]': new Date().toLocaleDateString('pt-BR'),
                    '[Desconto_Percentual]': '15',
                    '[Custo_Atual]': 'R$ 3.500,00',
                    '[Custo_OBY]': 'R$ 2.975,00',
                    '[Economia_Mensal]': 'R$ 525,00',
                    '[Razao_Social_Consorcio]': 'CONS√ìRCIO SOLAR PARAN√Å',
                    '[CNPJ_Consorcio]': '12.345.678/0001-90',
                };

                let previa = template;
                Object.keys(dadosExemplo).forEach(campo => {
                    previa = previa.replace(new RegExp(campo.replace(/[[\]]/g, '\\$&'), 'g'), dadosExemplo[campo]);
                });

                // Gerar DOCX
                const paragrafos = previa.split('\n').map(linha => {
                    const isTitulo = linha === linha.toUpperCase() && linha.length > 0 && linha.length < 100;
                    return new docx.Paragraph({
                        text: linha,
                        bold: isTitulo,
                        spacing: { after: isTitulo ? 300 : 200 }
                    });
                });

                const doc = new docx.Document({
                    sections: [{
                        properties: {
                            page: {
                                margin: { top: 1440, right: 1440, bottom: 1440, left: 1440 }
                            }
                        },
                        children: paragrafos
                    }]
                });

                docx.Packer.toBlob(doc).then(blob => {
                    saveAs(blob, 'Previa_Contrato.docx');
                    alert('‚úÖ Pr√©via gerada!');
                });
            };

            const categorias = [...new Set(campos.map(c => c.categoria))];

            return (
                <div className="min-h-screen bg-gray-50">
                    <div className="bg-gradient-to-r from-blue-600 to-purple-600 text-white p-6 shadow-lg">
                        <div className="container mx-auto">
                            <h1 className="text-3xl font-bold">üìÑ Gestor de Templates de Contrato</h1>
                            <p className="text-blue-100 mt-2">Personalize o template e gerencie campos vari√°veis</p>
                        </div>
                    </div>

                    <div className="container mx-auto p-6">
                        <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            {/* Campos Vari√°veis */}
                            <div className="lg:col-span-1">
                                <div className="bg-white rounded-xl shadow-lg p-6 sticky top-6">
                                    <h2 className="text-xl font-bold mb-4">üè∑Ô∏è Campos Vari√°veis</h2>
                                    
                                    {/* Adicionar Novo Campo */}
                                    <div className="bg-gray-50 p-4 rounded-lg mb-4">
                                        <h3 className="font-semibold mb-3">‚ûï Adicionar Campo</h3>
                                        <input
                                            type="text"
                                            placeholder="Nome do campo"
                                            value={novoCampo.nome}
                                            onChange={(e) => setNovoCampo({...novoCampo, nome: e.target.value})}
                                            className="w-full p-2 border rounded mb-2"
                                        />
                                        <input
                                            type="text"
                                            placeholder="Descri√ß√£o"
                                            value={novoCampo.descricao}
                                            onChange={(e) => setNovoCampo({...novoCampo, descricao: e.target.value})}
                                            className="w-full p-2 border rounded mb-2"
                                        />
                                        <select
                                            value={novoCampo.categoria}
                                            onChange={(e) => setNovoCampo({...novoCampo, categoria: e.target.value})}
                                            className="w-full p-2 border rounded mb-2"
                                        >
                                            <option value="Personalizado">Personalizado</option>
                                            <option value="Cliente">Cliente</option>
                                            <option value="Endere√ßo">Endere√ßo</option>
                                            <option value="Instala√ß√£o">Instala√ß√£o</option>
                                            <option value="Contrato">Contrato</option>
                                            <option value="Financeiro">Financeiro</option>
                                        </select>
                                        <button
                                            onClick={adicionarCampo}
                                            className="w-full px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700"
                                        >
                                            Adicionar Campo
                                        </button>
                                    </div>

                                    {/* Lista de Campos */}
                                    <div className="max-h-[600px] overflow-y-auto">
                                        {categorias.map(cat => (
                                            <div key={cat} className="mb-4">
                                                <h4 className="font-semibold text-sm text-gray-600 mb-2">{cat}</h4>
                                                {campos.filter(c => c.categoria === cat).map(campo => (
                                                    <div key={campo.id} className="bg-gray-50 p-2 rounded mb-2 flex justify-between items-center">
                                                        <div className="flex-1">
                                                            <button
                                                                onClick={() => inserirCampo(campo.nome)}
                                                                className="text-left w-full hover:text-blue-600"
                                                            >
                                                                <span className="font-mono text-sm text-blue-600">{campo.nome}</span>
                                                                <p className="text-xs text-gray-600">{campo.descricao}</p>
                                                            </button>
                                                        </div>
                                                        {campo.categoria === 'Personalizado' && (
                                                            <button
                                                                onClick={() => removerCampo(campo.id)}
                                                                className="ml-2 text-red-500 hover:text-red-700"
                                                            >
                                                                ‚ùå
                                                            </button>
                                                        )}
                                                    </div>
                                                ))}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>

                            {/* Editor de Template */}
                            <div className="lg:col-span-2">
                                <div className="bg-white rounded-xl shadow-lg p-6">
                                    <h2 className="text-xl font-bold mb-4">üìù Editor de Template</h2>
                                    
                                    <textarea
                                        id="editor-template"
                                        value={template}
                                        onChange={(e) => setTemplate(e.target.value)}
                                        className="w-full h-[600px] p-4 border rounded-lg font-mono text-sm"
                                        placeholder="Digite o template aqui. Clique nos campos ao lado para inserir vari√°veis."
                                    />

                                    <div className="flex gap-4 mt-4">
                                        <button
                                            onClick={salvarTemplate}
                                            disabled={salvando}
                                            className="flex-1 px-6 py-3 bg-blue-600 text-white rounded-lg font-semibold hover:bg-blue-700 disabled:opacity-50"
                                        >
                                            {salvando ? 'üíæ Salvando...' : 'üíæ Salvar Template'}
                                        </button>
                                        <button
                                            onClick={gerarPrevia}
                                            className="flex-1 px-6 py-3 bg-green-600 text-white rounded-lg font-semibold hover:bg-green-700"
                                        >
                                            üëÅÔ∏è Gerar Pr√©via DOCX
                                        </button>
                                    </div>

                                    <div className="mt-4 p-4 bg-blue-50 rounded-lg">
                                        <p className="text-sm text-gray-700">
                                            <strong>üí° Dica:</strong> Clique nos campos ao lado para inseri-los no template. 
                                            Os campos ser√£o substitu√≠dos automaticamente pelos dados reais ao gerar o contrato.
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        ReactDOM.render(<GestorTemplates />, document.getElementById('root'));
    </script>
</body>
</html>